montageDefine("737b12c","test/simple/test-stream2-basic",{dependencies:["../common.js","../../lib/_stream_readable","assert","util","events"],factory:function(e){function t(e){a.apply(this),this._buffer=new Buffer(e||100),this._buffer.fill("x"),this._pos=0,this._bufs=10}function n(){l.apply(this),this.received=[],this.flush=!1}function i(e,t){c++,u.push([e,t])}function r(){var e=u.shift();if(!e)return console.error("ok");var t=e[0],n=e[1];console.log("# %s",t),n({same:o.deepEqual,ok:o,equal:o.equal,end:function(){c--,r()}})}e("../common.js");var a=e("../../lib/_stream_readable"),o=e("assert"),s=e("util"),l=e("events").EventEmitter;s.inherits(t,a),t.prototype.read=function(e){if(0===e)return null;var t=this._buffer.length-this._pos;e=e||t,e=Math.max(e,0);var n=Math.min(e,t);if(0===n)return setTimeout(function(){this._pos=0,this._bufs-=1,0>=this._bufs?this.ended||(this.emit("end"),this.ended=!0):this.emit("readable")}.bind(this),10),null;var i=this._buffer.slice(this._pos,this._pos+n);return this._pos+=n,i},s.inherits(n,l),n.prototype.write=function(e){return this.received.push(""+e),this.emit("write",e),!0},n.prototype.end=function(e){e&&this.write(e),this.emit("end",this.received)};var u=[],c=0;process.on("exit",function(){o.equal(c,0)}),process.nextTick(r),i("a most basic test",function(e){function n(){for(var e;null!==(e=i.read(o++));)r.push(""+e);i.once("readable",n)}var i=new t(20),r=[],a=["x","xx","xxx","xxxx","xxxxx","xxxxx","xxxxxxxx","xxxxxxxxx","xxx","xxxxxxxxxxxx","xxxxxxxx","xxxxxxxxxxxxxxx","xxxxx","xxxxxxxxxxxxxxxxxx","xx","xxxxxxxxxxxxxxxxxxxx","xxxxxxxxxxxxxxxxxxxx","xxxxxxxxxxxxxxxxxxxx","xxxxxxxxxxxxxxxxxxxx","xxxxxxxxxxxxxxxxxxxx"];i.on("end",function(){e.same(r,a),e.end()});var o=1;n()}),i("pipe",function(e){var i=new t(5),r=["xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx"],a=new n;a.on("end",function(t){e.same(t,r),e.end()}),i.pipe(a)}),[1,2,3,4,5,6,7,8,9].forEach(function(e){i("unpipe",function(i){var r=new t(5),a=["xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx"];a=[a.slice(0,e),a.slice(e)];var o=[new n,new n],s=e;o[0].on("write",function(){0===--s&&(r.unpipe(),i.equal(r._readableState.pipes,null),o[0].end(),r.pipe(o[1]),i.equal(r._readableState.pipes,o[1]))});var l=0,u=!1,c=!1;o[0].on("end",function(e){i.equal(u,!1),u=!0,l++,i.same(e,a[0])}),o[1].on("end",function(e){i.equal(c,!1),c=!0,l++,i.equal(l,2),i.same(e,a[1]),i.end()}),r.pipe(o[0])})}),i("multipipe",function(e){var i=new t(5),r=[new n,new n],a=["xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx"],o=2;r[0].on("end",function(t){e.same(t,a,"first"),0===--o&&e.end()}),r[1].on("end",function(t){e.same(t,a,"second"),0===--o&&e.end()}),i.pipe(r[0]),i.pipe(r[1])}),[1,2,3,4,5,6,7,8,9].forEach(function(e){i("multi-unpipe",function(i){var r=new t(5),a=["xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx"];a=[a.slice(0,e),a.slice(e)];var o=[new n,new n,new n],s=e;o[0].on("write",function(){0===--s&&(r.unpipe(),o[0].end(),r.pipe(o[1]))});var l=0;o[0].on("end",function(e){l++,i.same(e,a[0])}),o[1].on("end",function(e){l++,i.equal(l,2),i.same(e,a[1]),i.end()}),r.pipe(o[0]),r.pipe(o[2])})}),i("back pressure respected",function(e){function t(){}var n=new a({objectMode:!0});n._read=t;var i=0;n.push(["one"]),n.push(["two"]),n.push(["three"]),n.push(["four"]),n.push(null);var r=new a;r.write=function(e){o.equal(e[0],"one"),r.emit("close"),process.nextTick(function(){n.pipe(l),n.pipe(u)})},r.end=t,n.pipe(r);var s=["two","two","three","three","four","four"],l=new a;l.write=function(e){return o.equal(e[0],s.shift()),o.equal(i,0),i++,"four"===e[0]?!0:(setTimeout(function(){i--,l.emit("drain")},10),!1)},l.end=t;var u=new a;u.write=function(e){return o.equal(e[0],s.shift()),o.equal(i,1),i++,"four"===e[0]?!0:(setTimeout(function(){i--,u.emit("drain")},50),!1)},u.end=function(){o.equal(i,2),o.equal(s.length,0),e.end()}}),i("read(0) for ended streams",function(e){var t=new a,n=!1,i=!1;t._read=function(){},t.push(new Buffer("foo")),t.push(null);var r=t.read(0);o.equal(r,null);var s=new a;s.write=function(e){n=!0,o.equal(i,!1),o.equal(""+e,"foo")},s.end=function(){i=!0,o.equal(n,!0),e.end()},t.pipe(s)}),i("sync _read ending",function(e){var t=new a,n=!1;t._read=function(){t.push(null)},t.once("end",function(){n=!0}),t.read(),process.nextTick(function(){o.equal(n,!0),e.end()})}),i("adding readable triggers data flow",function(e){var t=new a({highWaterMark:5}),n=!1,i=0;t._read=function(){2===i++?t.push(null):t.push(new Buffer("asdf"))},t.on("readable",function(){n=!0,t.read()}),t.on("end",function(){e.equal(i,3),e.ok(n),e.end()})})}});